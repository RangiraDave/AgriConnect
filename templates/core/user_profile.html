<!-- templates/core/user_profile.html -->
{% extends 'core/base.html' %}
{% load i18n static %}

{% block title %}User Profile - AgriConnect{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2>Welcome, {{ request.user.username }}!</h2>
  
  <div class="row">
    <div class="col-md-4">
      <!-- Basic user info card -->
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">{{ request.user.username }}</h5>
          <p><strong>Role:</strong> {{ profile.role|title }}</p>
          <p><strong>Phone:</strong> {{ profile.phone|default:"Not Provided" }}</p>
          {% if profile.bio %}
            <p><strong>Bio:</strong> {{ profile.bio }}</p>
          {% endif %}
        </div>
        {% if request.user.profile.role|lower in "umuhinzi,cooperative" %}
            <div class="card-footer">
                <a href="{% url 'add_product' %}" class="btn btn-primary w-100 mb-2">
                    <i class="fas fa-plus me-2"></i>{% trans "Add Product" %}
                </a>
                <a href="{% url 'market_insights' %}" class="btn btn-info w-100">
                    <i class="fas fa-chart-line me-2"></i>{% trans "View Market Insights" %}
                </a>
            </div>
        {% endif %}
      </div>
    </div>
    
    <div class="col-md-8">
      {% if request.user.profile.role|lower in "umuhinzi,cooperative" %}
        {% if product_count == 0 %}
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>{% trans "You haven't added any products yet!" %}
          </div>
        {% else %}
          <h4>{% trans "Your Products" %}</h4>
          <div class="row">
            {% for product in products %}
              <div class="col-md-6 mb-3">
                <div class="card h-100">
                  {% if product.media %}
                    <img src="{{ product.media.url }}" class="card-img-top" alt="{{ product.name }}">
                  {% else %}
                    <img src="{% static 'img/no_image.png' %}" class="card-img-top" alt="No Image">
                  {% endif %}
                  <div class="card-body">
                    <h5 class="card-title">{{ product.name }}</h5>
                    <p class="card-text">
                      <strong>{% trans "Price" %}:</strong> {{ product.price_per_unit }} RWF<br>
                      <strong>{% trans "Quantity" %}:</strong> {{ product.quantity_available }} {{ product.unit }}
                    </p>
                    {% if product.description %}
                      <p class="card-text">{{ product.description|truncatewords:20 }}...</p>
                    {% endif %}
                  </div>
                  <div class="card-footer bg-transparent">
                    <div class="btn-group w-100">
                      <a href="{% url 'edit_product' pk=product.id %}" class="btn btn-outline-primary">
                        <i class="fas fa-edit me-1"></i>{% trans "Edit" %}
                      </a>
                      <a href="{% url 'delete_product' pk=product.id %}" class="btn btn-outline-danger">
                        <i class="fas fa-trash me-1"></i>{% trans "Delete" %}
                      </a>
                    </div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% endif %}
      {% endif %}
    </div>
  </div>
  
  <div class="mt-4">
    <form method="post" action="{% url 'delete_account' %}" style="display:inline;">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">
        <i class="fas fa-user-times me-2"></i>{% trans "Delete Account" %}
      </button>
    </form>
  </div>
</div>

<script>
const socket = new WebSocket("ws://" + window.location.host + "/ws/notifications/");

socket.onmessage = function(event) {
    const data = JSON.parse(event.data);
    showToastNotification(data.message);
};

function showToastNotification(message) {
    const notificationBox = document.getElementById("notifications");
    const newNotification = document.createElement("div");
    newNotification.classList.add("alert", "alert-success");
    newNotification.innerHTML = message;
    notificationBox.appendChild(newNotification);

    setTimeout(() => {
        newNotification.remove();
    }, 5000);
}
</script>
{% endblock %}
