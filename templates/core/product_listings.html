{% extends 'core/base.html' %}
{% load i18n static %}
{% load time_ago %}

{% block title %}Product Listings - AgriConnect{% endblock %}

{% block content %}
<div class="container">
    <!-- Welcome Section -->
    <div class="welcome-section text-center mb-5 fade-in">
        <h1 class="display-4 mb-3">{{ welcome_message }}</h1>
        <!-- <p class="lead text-muted">
            {% trans "Ngibi ibicuruzwa bikeneye abaguzi byashyizweho n'abahinzi bo mu Rwanda bagera kuri" %} 
            <span class="badge bg-success">{{ user_count }}</span>
        </p> -->
        <div class="stats-banner d-flex justify-content-center gap-4 mt-4">
            <div class="stat-item">
                <i class="fas fa-box-open fa-2x text-success mb-2"></i>
                <h3>{{ total_products }}</h3>
                <p class="text-muted">{% trans "Total Products" %}</p>
            </div>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="filter-section mb-4">
        <div class="card filter-card">
            <div class="card-header filter-header" id="filterHeader">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>{% trans "Filters" %}
                    </h5>
                    <button class="btn btn-link" type="button" data-bs-toggle="collapse" data-bs-target="#filterCollapse">
                        <i class="fas fa-chevron-down"></i>
                    </button>
                </div>
            </div>
            <div id="filterCollapse" class="collapse">
                <div class="card-body">
                    <form id="filter-form" method="GET" class="row g-3">
                        <!-- Search Bar -->
                        <div class="col-md-12 mb-3">
                            <div class="input-group search-group">
                                <span class="input-group-text bg-white">
                                    <i class="fas fa-search text-success"></i>
                                </span>
                                <input type="text" name="search" class="form-control search-input" 
                                       placeholder="{% trans 'Search products...' %}" 
                                       value="{{ request.GET.search }}">
                            </div>
                        </div>

                        <!-- Location Filters -->
                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-map-marker-alt text-success me-1"></i>{% trans "Province" %}
                            </label>
                            <select name="province" id="province" class="form-select">
                                <option value="">{% trans "Select Province" %}</option>
                                {% for province in provinces %}
                                    <option value="{{ province.id }}" {% if selected_province == province.id|stringformat:"i" %}selected{% endif %}>
                                        {{ province.name }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-map text-success me-1"></i>{% trans "District" %}
                            </label>
                            <select name="district" id="district" class="form-select" {% if not selected_province %}disabled{% endif %}>
                                <option value="">{% trans "Select District" %}</option>
                            </select>
                        </div>

                        <div class="col-md-4">
                            <label class="form-label">
                                <i class="fas fa-compass text-success me-1"></i>{% trans "Sector" %}
                            </label>
                            <select name="sector" id="sector" class="form-select" {% if not selected_district %}disabled{% endif %}>
                                <option value="">{% trans "Select Sector" %}</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-th-large text-success me-1"></i>{% trans "Cell" %}
                            </label>
                            <select name="cell" id="cell" class="form-select" {% if not selected_sector %}disabled{% endif %}>
                                <option value="">{% trans "Select Cell" %}</option>
                            </select>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">
                                <i class="fas fa-home text-success me-1"></i>{% trans "Village" %}
                            </label>
                            <select name="village" id="village" class="form-select" {% if not selected_cell %}disabled{% endif %}>
                                <option value="">{% trans "Select Village" %}</option>
                            </select>
                        </div>

                        <!-- Filter Buttons -->
                        <div class="col-12 text-end">
                            <button type="submit" class="btn btn-success btn-lg">
                                <i class="fas fa-filter me-2"></i>{% trans "Apply Filters" %}
                            </button>
                            <a href="{% url 'product_listings' %}" class="btn btn-outline-secondary btn-lg ms-2">
                                <i class="fas fa-times me-2"></i>{% trans "Clear Filters" %}
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const filterCard = document.querySelector('.filter-card');
        const filterCollapse = document.getElementById('filterCollapse');
        const filterHeader = document.getElementById('filterHeader');
        let isMobile = window.innerWidth <= 768;
        let hoverTimeout;

        // Function to handle filter visibility
        function handleFilterVisibility(show) {
            const bsCollapse = bootstrap.Collapse.getInstance(filterCollapse) || 
                              new bootstrap.Collapse(filterCollapse, { toggle: false });
            
            if (show) {
                bsCollapse.show();
            } else {
                bsCollapse.hide();
            }
        }

        // Handle hover events for desktop
        if (!isMobile) {
            filterCard.addEventListener('mouseenter', () => {
                clearTimeout(hoverTimeout);
                handleFilterVisibility(true);
            });

            filterCard.addEventListener('mouseleave', () => {
                hoverTimeout = setTimeout(() => {
                    handleFilterVisibility(false);
                }, 300); // Small delay to prevent flickering
            });
        }

        // Handle click events for mobile
        filterHeader.addEventListener('click', (e) => {
            if (isMobile) {
                e.preventDefault();
                const isCollapsed = !filterCollapse.classList.contains('show');
                handleFilterVisibility(isCollapsed);
            }
        });

        // Update mobile detection on window resize
        window.addEventListener('resize', () => {
            isMobile = window.innerWidth <= 768;
        });

        // Prevent form submission from closing the filter on mobile
        const filterForm = document.getElementById('filter-form');
        filterForm.addEventListener('click', (e) => {
            if (isMobile) {
                e.stopPropagation();
            }
        });
    });
    </script>

    <!-- Products Grid -->
    <div class="product-grid">
        {% if products %}
            {% for product in products %}
                <div class="card product-card fade-in">
                    <!-- Product Media: Remove unwanted space by removing 'card-img-top' class -->
                    <div class="card-img-wrapper">
                        {% if product.media %}
                            {% with ext=product.media.url|lower|slice:"-4:" %}
                                {% if ext == ".mp4" %}
                                    <video controls>
                                        <source src="{{ product.media.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <img src="{{ product.media.url }}" alt="{{ product.name }}">
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <img src="{% static 'img/no_image.png' %}" alt="{{ product.name }}">
                        {% endif %}
                        <!-- <div class="card-img-overlay d-flex justify-content-end">
                            <span class="badge bg-success">{{ product.unit }}</span>
                        </div> -->
                    </div>
                    <!-- End Product Media -->
                    <div class="card-body">
                        <h5 class="card-title">{{ product.name }}</h5>
                        {% if product.description %}
                            <p class="card-text text-muted">{{ product.description|truncatewords:15 }}</p>
                        {% endif %}
                        
                        <div class="product-meta">
                            <div class="owner-info mb-2">
                                <i class="fas fa-user text-success me-1"></i>
                                <small>{{ product.owner.profile.role|capfirst }} - {{ product.owner.username }}</small>
                            </div>
                            <div class="contact-info mb-2">
                                <i class="fas fa-phone text-success me-1"></i>
                                <small>{% if product.contact_number %}{{ product.contact_number }}{% else %}{% trans "Not Provided" %}{% endif %}</small>
                            </div>
                            <div class="time-info mb-2">
                                <i class="fas fa-clock text-success me-1"></i>
                                <small class="text-muted">
                                    <!-- <i class="far fa-clock me-1"></i> -->
                                    {% trans "Added" %} {{ product.created_at|concise_timesince }}
                                </small>
                            </div>
                            {% if product.location %}
                                <div class="location-info mb-2">
                                    <i class="fas fa-map-marker-alt text-success me-1"></i>
                                    <small>{{ product.location }}</small>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Rating Section -->
                        <div class="rating-section mt-3">
                            <form action="{% url 'rate_product' product.id %}" method="POST" class="rating-form">
                                {% csrf_token %}
                                <div class="stars">
                                    {% for i in "12345" %}
                                        <i class="fas fa-star star" data-value="{{ i }}"></i>
                                    {% endfor %}
                                </div>
                                <input type="hidden" name="rating" class="rating-value">
                                <button type="submit" class="btn btn-sm btn-success mt-2 submit-rating" style="display: none;">
                                    {% trans "Submit Rating" %}
                                </button>
                            </form>
                            {% if product.ratings.all %}
                                <div class="current-rating mt-2">
                                    <i class="fas fa-star text-warning"></i>
                                    <span>{{ product.ratings.all|length }} {% trans "ratings" %}</span>
                                </div>
                            {% endif %}
                        </div>

                        <!-- Chat Button -->
                        <button class="btn btn-primary w-100 mt-3 chatbot-button" data-product-id="{{ product.id }}">
                            <i class="fas fa-comments me-2"></i>{% trans "Talk to us" %}
                        </button>

                        <div class="d-flex justify-content-between align-items-center">
                            <span class="h5 mb-0">{{ product.price_per_unit }} RWF</span>
                            <a href="{% url 'product_detail' product.id %}" class="btn btn-outline-success">
                                <i class="fas fa-eye me-1"></i>{% trans "View" %}
                            </a>
                        </div>
                    </div>
                </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-box-open fa-3x text-muted mb-3"></i>
                <h3>{% trans "No products found" %}</h3>
                <p class="text-muted">{% trans "Try adjusting your filters or search criteria" %}</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Chatbot Interface -->
<div id="chatbot" class="chatbot" style="display: none;">
    <div class="chatbot-header">
        <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Chat with us</h5>
        <button class="btn-close btn-close-white" onclick="closeChatbot()"></button>
    </div>
    <div class="chatbot-body">
        <!-- Chat messages will be appended here -->
    </div>
    <div class="chatbot-footer">
        <input type="text" id="chatbot-input" class="form-control" placeholder="Type your message...">
        <button class="btn btn-success ms-2" onclick="sendMessage()">
            <i class="fas fa-paper-plane"></i>
        </button>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize WebSocket connection
    const ws_scheme = window.location.protocol === "https:" ? "wss" : "ws";
    const notificationSocket = new WebSocket(
        ws_scheme + '://' + window.location.host + '/ws/notifications/'
    );

    notificationSocket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        showToast(data.message);
    };

    // Initialize location dropdowns
    const provinceSelect = document.getElementById('province');
    const districtSelect = document.getElementById('district');
    const sectorSelect = document.getElementById('sector');
    const cellSelect = document.getElementById('cell');
    const villageSelect = document.getElementById('village');

    // Load initial values if they exist
    const selectedProvince = "{{ selected_province }}";
    const selectedDistrict = "{{ selected_district }}";
    const selectedSector = "{{ selected_sector }}";
    const selectedCell = "{{ selected_cell }}";
    const selectedVillage = "{{ selected_village }}";

    if (selectedProvince) {
        loadDistricts(selectedProvince).then(() => {
            if (selectedDistrict) {
                loadSectors(selectedDistrict).then(() => {
                    if (selectedSector) {
                        loadCells(selectedSector).then(() => {
                            if (selectedCell) {
                                loadVillages(selectedCell);
                            }
                        });
                    }
                });
            }
        });
    }

    // Event listeners for location dropdowns
    provinceSelect.addEventListener('change', function() {
        const provinceId = this.value;
        resetDropdowns(districtSelect, sectorSelect, cellSelect, villageSelect);
        
        if (provinceId) {
            loadDistricts(provinceId);
        }
    });

    districtSelect.addEventListener('change', function() {
        const districtId = this.value;
        resetDropdowns(sectorSelect, cellSelect, villageSelect);
        
        if (districtId) {
            loadSectors(districtId);
        }
    });

    sectorSelect.addEventListener('change', function() {
        const sectorId = this.value;
        resetDropdowns(cellSelect, villageSelect);
        
        if (sectorId) {
            loadCells(sectorId);
        }
    });

    cellSelect.addEventListener('change', function() {
        const cellId = this.value;
        resetDropdowns(villageSelect);
        
        if (cellId) {
            loadVillages(cellId);
        }
    });

    // Helper function to reset dropdowns
    function resetDropdowns(...dropdowns) {
        dropdowns.forEach(dropdown => {
            dropdown.innerHTML = `<option value="">${dropdown.dataset.placeholder || 'Select...'}</option>`;
            dropdown.disabled = true;
        });
    }

    // Functions to load location data
    async function loadDistricts(provinceId) {
        try {
            districtSelect.disabled = true;
            const response = await fetch(`/api/districts/?province=${provinceId}`);
            if (!response.ok) {
                throw new Error('Failed to load districts');
            }
            const districts = await response.json();
            
            districtSelect.innerHTML = '<option value="">{% trans "Select District" %}</option>';
            districts.forEach(district => {
                const option = document.createElement('option');
                option.value = district.id;
                option.textContent = district.name;
                if (district.id == selectedDistrict) {
                    option.selected = true;
                }
                districtSelect.appendChild(option);
            });
            districtSelect.disabled = false;
        } catch (error) {
            console.error('Error loading districts:', error);
            showError('Failed to load districts. Please try again.');
            districtSelect.disabled = true;
        }
    }

    async function loadSectors(districtId) {
        try {
            sectorSelect.disabled = true;
            const response = await fetch(`/api/sectors/?district=${districtId}`);
            if (!response.ok) {
                throw new Error('Failed to load sectors');
            }
            const sectors = await response.json();
            
            sectorSelect.innerHTML = '<option value="">{% trans "Select Sector" %}</option>';
            sectors.forEach(sector => {
                const option = document.createElement('option');
                option.value = sector.id;
                option.textContent = sector.name;
                if (sector.id == selectedSector) {
                    option.selected = true;
                }
                sectorSelect.appendChild(option);
            });
            sectorSelect.disabled = false;
        } catch (error) {
            console.error('Error loading sectors:', error);
            showError('Failed to load sectors. Please try again.');
            sectorSelect.disabled = true;
        }
    }

    async function loadCells(sectorId) {
        try {
            cellSelect.disabled = true;
            const response = await fetch(`/api/cells/?sector=${sectorId}`);
            if (!response.ok) {
                throw new Error('Failed to load cells');
            }
            const cells = await response.json();
            
            cellSelect.innerHTML = '<option value="">{% trans "Select Cell" %}</option>';
            cells.forEach(cell => {
                const option = document.createElement('option');
                option.value = cell.id;
                option.textContent = cell.name;
                if (cell.id == selectedCell) {
                    option.selected = true;
                }
                cellSelect.appendChild(option);
            });
            cellSelect.disabled = false;
        } catch (error) {
            console.error('Error loading cells:', error);
            showError('Failed to load cells. Please try again.');
            cellSelect.disabled = true;
        }
    }

    async function loadVillages(cellId) {
        try {
            villageSelect.disabled = true;
            const response = await fetch(`/api/villages/?cell=${cellId}`);
            if (!response.ok) {
                throw new Error('Failed to load villages');
            }
            const villages = await response.json();
            
            villageSelect.innerHTML = '<option value="">{% trans "Select Village" %}</option>';
            villages.forEach(village => {
                const option = document.createElement('option');
                option.value = village.id;
                option.textContent = village.name;
                if (village.id == selectedVillage) {
                    option.selected = true;
                }
                villageSelect.appendChild(option);
            });
            villageSelect.disabled = false;
        } catch (error) {
            console.error('Error loading villages:', error);
            showError('Failed to load villages. Please try again.');
            villageSelect.disabled = true;
        }
    }

    // Function to show error messages
    function showError(message) {
        const errorDiv = document.createElement('div');
        errorDiv.className = 'alert alert-danger alert-dismissible fade show';
        errorDiv.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;
        document.querySelector('.filter-section').prepend(errorDiv);
        
        // Auto-dismiss after 5 seconds
        setTimeout(() => {
            errorDiv.remove();
        }, 5000);
    }

    // Rating functionality
    document.querySelectorAll('.rating-form').forEach(form => {
        const stars = form.querySelectorAll('.star');
        const ratingInput = form.querySelector('.rating-value');
        const submitButton = form.querySelector('.submit-rating');

        stars.forEach(star => {
            star.addEventListener('click', function() {
                const rating = this.getAttribute('data-value');
                ratingInput.value = rating;
                highlightStars(stars, rating);
                submitButton.style.display = 'block';
            });

            star.addEventListener('mouseover', function() {
                const rating = this.getAttribute('data-value');
                highlightStars(stars, rating);
            });
        });

        form.addEventListener('mouseleave', function() {
            const currentRating = ratingInput.value;
            highlightStars(stars, currentRating);
        });

        form.addEventListener('submit', function(e) {
            e.preventDefault();
            const formData = new FormData(this);
            
            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': formData.get('csrfmiddlewaretoken')
                }
            })
            .then(response => {
                if (response.ok) {
                    showToast('Rating submitted successfully!');
                    submitButton.style.display = 'none';
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error submitting rating');
            });
        });
    });

    // Chatbot functionality
    document.querySelectorAll('.chatbot-button').forEach(button => {
        button.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            openChatbot(productId);
        });
    });

    // Auto-collapse filter after 5 seconds of inactivity
    let filterTimeout;
    const filterCollapse = document.getElementById('filterCollapse');
    const filterHeader = document.getElementById('filterHeader');

    function resetFilterTimeout() {
        clearTimeout(filterTimeout);
        filterTimeout = setTimeout(() => {
            if (filterCollapse.classList.contains('show')) {
                bootstrap.Collapse.getInstance(filterCollapse).hide();
            }
        }, 5000);
    }

    // Reset timeout on any interaction with the filter form
    document.getElementById('filter-form').addEventListener('mouseover', resetFilterTimeout);
    document.getElementById('filter-form').addEventListener('mouseout', resetFilterTimeout);
    document.getElementById('filter-form').addEventListener('focusin', resetFilterTimeout);
    document.getElementById('filter-form').addEventListener('focusout', resetFilterTimeout);

    // Show filter on hover
    filterHeader.addEventListener('mouseover', function() {
        if (!filterCollapse.classList.contains('show')) {
            bootstrap.Collapse.getInstance(filterCollapse).show();
        }
        resetFilterTimeout();
    });

    // Initialize tooltips
    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function highlightStars(stars, rating) {
    stars.forEach(star => {
        const value = star.getAttribute('data-value');
        if (value <= rating) {
            star.classList.add('text-warning');
        } else {
            star.classList.remove('text-warning');
        }
    });
}

function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast fade-in';
    toast.innerHTML = `
        <div class="toast-body">
            <i class="fas fa-bell me-2"></i>${message}
        </div>
    `;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 5000);
}

function openChatbot(productId) {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'block';
    chatbot.setAttribute('data-product-id', productId);
    
    // Clear previous messages
    const chatBody = chatbot.querySelector('.chatbot-body');
    chatBody.innerHTML = '';
    
    // Add welcome message
    const welcomeMessage = document.createElement('div');
    welcomeMessage.className = 'message bot-message';
    welcomeMessage.textContent = 'Hello! How can I help you with this product?';
    chatBody.appendChild(welcomeMessage);
}

function closeChatbot() {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'none';
    chatbot.querySelector('.chatbot-body').innerHTML = '';
    document.getElementById('chatbot-input').value = '';
}

function sendMessage() {
    const input = document.getElementById('chatbot-input');
    const message = input.value.trim();
    const productId = document.getElementById('chatbot').getAttribute('data-product-id');

    if (message) {
        const chatBody = document.querySelector('.chatbot-body');
        
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.textContent = message;
        chatBody.appendChild(userMessage);
        
        // Clear input
        input.value = '';

        // Send message to server
        fetch(`/chatbot/get_response/?message=${encodeURIComponent(message)}&product_id=${encodeURIComponent(productId)}`)
            .then(response => response.json())
            .then(data => {
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.textContent = data.response;
                chatBody.appendChild(botMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('Error sending message');
            });
    }
}

// Add event listener for Enter key in chat input
document.getElementById('chatbot-input').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        e.preventDefault();
        sendMessage();
    }
});
</script>

<style>
/* Filter Card Styles */
.filter-card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    border-radius: 1rem;
    overflow: hidden;
}

.filter-card:hover {
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.filter-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #e9ecef;
    cursor: pointer;
    transition: background-color 0.3s ease;
    padding: 1rem;
}

.filter-header:hover {
    background-color: #e9ecef;
}

/* Search Input Styles */
.search-group {
    border-radius: 25px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    border: 1px solid #dee2e6;
}

.search-input {
    border: none;
    padding: 12px;
}

.search-input:focus {
    box-shadow: none;
    border-color: #28a745;
}

/* Select Styles */
.form-select {
    border-radius: 8px;
    padding: 10px;
    border: 1px solid #dee2e6;
    transition: all 0.3s ease;
    background-color: #fff;
}

.form-select:hover {
    border-color: #28a745;
}

.form-select:focus {
    border-color: #28a745;
    box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25);
}

/* Button Styles */
.btn-success {
    border-radius: 8px;
    padding: 10px 20px;
    transition: all 0.3s ease;
}

.btn-success:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.2);
}

.btn-outline-secondary {
    border-radius: 8px;
    padding: 10px 20px;
    transition: all 0.3s ease;
}

.btn-outline-secondary:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(108, 117, 125, 0.2);
}

/* Form Label Styles */
.form-label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 8px;
}

/* Animation for collapse */
.collapse {
    transition: all 0.3s ease;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .filter-card {
        margin: 0 -15px;
        border-radius: 0;
    }
    
    .btn-lg {
        padding: 8px 16px;
        font-size: 1rem;
    }

    .filter-header {
        padding: 0.75rem;
    }
}
</style>
{% endblock %}