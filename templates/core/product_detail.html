{% extends 'core/base.html' %}
{% load i18n static %}
{% load time_ago %}

{% block title %}Product Detail - AgriConnect{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            {% if product.media %}
                {% with ext=product.media.url|lower|slice:"-4:" %}
                    {% if ext == ".mp4" %}
                        <video controls class="img-fluid rounded">
                            <source src="{{ product.media.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% else %}
                        <img src="{{ product.media.url }}" alt="{{ product.name }}" class="img-fluid rounded">
                    {% endif %}
                {% endwith %}
            {% elif product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded">
            {% else %}
                <img src="{% static 'img/no_image.png' %}" alt="{{ product.name }}" class="img-fluid rounded">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p>{{ product.description }}</p>
            <p><strong>Price:</strong> {{ product.price_per_unit }}</p>
            <p><strong>Quantity:</strong> {{ product.quantity_available }} {{ product.unit }}</p>
            <div class="location-section mb-3">
                {% if product.latitude and product.longitude %}
                    <p><strong>{% trans "Location:" %}</strong> {{ product.latitude }}, {{ product.longitude }}</p>
                    <a href="https://www.google.com/maps?q={{ product.latitude }},{{ product.longitude }}"
                       target="_blank"
                       class="btn btn-outline-secondary btn-sm mt-2">
                        <i class="fas fa-map-marker-alt me-1"></i>
                        {% trans "View on Map" %}
                    </a>
                {% else %}
                    <p><strong>{% trans "Location:" %}</strong> {% trans "Location not provided." %}</p>
                {% endif %}
            </div>
            <p><strong>Contact:</strong> {% if product.contact_number %}{{ product.contact_number }}{% else %}{% trans "Not Provided" %}{% endif %}</p>
            <p class="text-muted">
                <small>
                    <i class="far fa-clock me-1"></i>
                    {% trans "Added" %} {{ product.created_at|concise_timesince }}
                </small>
            </p>

            <!-- Talk to us button -->
            <button id="talk-to-us" class="btn btn-primary">Talk to us</button>
        </div>
    </div>

    <!-- Chatbot window (fixed markup) -->
    <div id="chatbot" class="chatbot" style="display: none;">
        <div class="chatbot-header">
            <h5 class="mb-0">
                <i class="fas fa-robot me-2"></i>
                <span id="chatbot-title">{{ product.name }} - {{ product.owner.username }}</span>
            </h5>
            <button class="btn-close btn-close-white" onclick="closeChatbot()"></button>
        </div>
        <div class="chatbot-hint">
            <p class="text-muted small mb-2">
                <i class="fas fa-lightbulb"></i> Ask about product details, price, availability, or contact information.
            </p>
        </div>
        <div class="chatbot-body">
            <!-- Chat messages will be appended here -->
        </div>
        <div class="chatbot-footer">
            <input type="text" id="chatbot-input" class="form-control" placeholder="Type your message...">
            <button class="btn btn-success ms-2" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
// Removed the old Location button handler script

// Fix for district loading (Keep this if needed for other parts of the page)
document.addEventListener('DOMContentLoaded', function() {
    const provinceSelect = document.getElementById('province');
    if (provinceSelect) {
        provinceSelect.addEventListener('change', function() {
            const provinceId = this.value;
            if (provinceId) {
                loadDistricts(provinceId);
            }
        });
    }
});

function loadDistricts(provinceId) {
    fetch(`/api/districts/?province=${provinceId}`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Failed to load districts');
            }
            return response.json();
        })
        .then(districts => {
            const districtSelect = document.getElementById('district');
            if (districtSelect) {
                districtSelect.innerHTML = '<option value="">{% trans "Select District" %}</option>';
                districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.id;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });
                districtSelect.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error loading districts:', error);
            showError('Failed to load districts. Please try again.');
        });
}

function showError(message) {
    const errorDiv = document.createElement('div');
    errorDiv.className = 'alert alert-danger alert-dismissible fade show';
    errorDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.location-section').prepend(errorDiv);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        errorDiv.remove();
    }, 5000);
}

// Original talk-to-us button code
document.getElementById('talk-to-us').addEventListener('click', function() {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'block';
    const chatBody = chatbot.querySelector('.chatbot-body');
    chatBody.innerHTML = '';
    const userName = "{{ request.user.username }}";
    const productName = "{{ product.name }}";
    const welcomeMessage = `Hello ${userName}, thank you for choosing ${productName}. I am LEA. How may I assist you?`;
    const botMessage = document.createElement('div');
    botMessage.className = 'message bot-message';
    botMessage.textContent = welcomeMessage;
    chatBody.appendChild(botMessage);
    chatBody.scrollTop = chatBody.scrollHeight;
});

// Fix the function name to match the onclick attribute
function sendMessage() {
    const input = document.getElementById('chatbot-input');
    const message = input.value.trim();
    const productId = "{{ product.id }}";
    const sessionId = document.getElementById('chatbot').getAttribute('data-session-id') || '';
    
    if (message) {
        const chatBody = document.querySelector('.chatbot-body');
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.textContent = message;
        chatBody.appendChild(userMessage);
        input.value = '';
        // Send message to server
        fetch(`/chatbot/get_response/?message=${encodeURIComponent(message)}&product_id=${productId}&session_id=${encodeURIComponent(sessionId)}`)
            .then(response => response.json())
            .then(data => {
                // Store session ID for conversation continuity
                document.getElementById('chatbot').setAttribute('data-session-id', data.session_id || '');
                
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.textContent = data.response;
                chatBody.appendChild(botMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            })
            .catch(error => {
                console.error('Error:', error);
                const errorMessage = document.createElement('div');
                errorMessage.className = 'message bot-message';
                errorMessage.textContent = "I'm sorry, I couldn't process your request. Please try again.";
                chatBody.appendChild(errorMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            });
    }
}

function closeChatbot() {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'none';
    chatbot.querySelector('.chatbot-body').innerHTML = '';
    document.getElementById('chatbot-input').value = '';
}

// Add event listener for Enter key
document.getElementById('chatbot-input').addEventListener('keypress', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        sendMessage();
    }
});
</script>
{% endblock %}
