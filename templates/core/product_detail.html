{% extends 'core/base.html' %}
{% load static %}
{% load i18n %}
{% load time_ago %}

{% block title %}Product Detail - AgriConnect{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-6">
            {% if product.media %}
                {% with ext=product.media.url|lower|slice:"-4:" %}
                    {% if ext == ".mp4" %}
                        <video controls class="img-fluid rounded">
                            <source src="{{ product.media.url }}" type="video/mp4">
                            Your browser does not support the video tag.
                        </video>
                    {% else %}
                        <img src="{{ product.media.url }}" alt="{{ product.name }}" class="img-fluid rounded">
                    {% endif %}
                {% endwith %}
            {% elif product.image %}
                <img src="{{ product.image.url }}" alt="{{ product.name }}" class="img-fluid rounded">
            {% else %}
                <img src="{% static 'img/no_image.png' %}" alt="{{ product.name }}" class="img-fluid rounded">
            {% endif %}
        </div>
        <div class="col-md-6">
            <h2>{{ product.name }}</h2>
            <p>{{ product.description }}</p>
            <p><strong>Price:</strong> {{ product.price_per_unit }}</p>
            <p><strong>Quantity:</strong> {{ product.quantity_available }} {{ product.unit }}</p>
            <p><strong>Location:</strong> {{ product.location }}</p>
            <p class="text-muted">
                <small>
                    <i class="far fa-clock me-1"></i>
                    {% trans "Added" %} {{ product.created_at|concise_timesince }}
                </small>
            </p>

            <!-- Talk to us button -->
            <button id="talk-to-us" class="btn btn-primary">Talk to us</button>
        </div>
    </div>

    <!-- Chatbot window (fixed markup) -->
    <div id="chatbot" class="chatbot" style="display: none;">
        <div class="chatbot-header">
            <h5 class="mb-0"><i class="fas fa-robot me-2"></i>Chat with us</h5>
            <button class="btn-close btn-close-white" onclick="closeChatbot()"></button>
        </div>
        <div class="chatbot-body">
            <!-- Chat messages will be appended here -->
        </div>
        <div class="chatbot-footer">
            <input type="text" id="chatbot-input" class="form-control" placeholder="Type your message...">
            <button class="btn btn-success ms-2" onclick="sendMessage()">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
    </div>
</div>

<script>
document.getElementById('talk-to-us').addEventListener('click', function() {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'block';
    const chatBody = chatbot.querySelector('.chatbot-body');
    chatBody.innerHTML = '';
    const userName = "{{ request.user.username }}";
    const productName = "{{ product.name }}";
    const welcomeMessage = `Hello ${userName}, thank you for choosing ${productName}. I am LEA. How may I assist you?`;
    const botMessage = document.createElement('div');
    botMessage.className = 'message bot-message';
    botMessage.textContent = welcomeMessage;
    chatBody.appendChild(botMessage);
    chatBody.scrollTop = chatBody.scrollHeight;
});

document.getElementById('send-message').addEventListener('click', function() {
    const input = document.getElementById('chatbot-input');
    const message = input.value.trim();
    const productId = "{{ product.id }}";
    if (message) {
        const chatBody = document.querySelector('.chatbot-body');
        // Add user message
        const userMessage = document.createElement('div');
        userMessage.className = 'message user-message';
        userMessage.textContent = message;
        chatBody.appendChild(userMessage);
        input.value = '';
        // Send message to server
        fetch(`/chatbot/get_response/?message=${encodeURIComponent(message)}&product_id=${productId}`)
            .then(response => response.json())
            .then(data => {
                const botMessage = document.createElement('div');
                botMessage.className = 'message bot-message';
                botMessage.textContent = data.response;
                chatBody.appendChild(botMessage);
                chatBody.scrollTop = chatBody.scrollHeight;
            });
    }
});

function closeChatbot() {
    const chatbot = document.getElementById('chatbot');
    chatbot.style.display = 'none';
    chatbot.querySelector('.chatbot-body').innerHTML = '';
    document.getElementById('chatbot-input').value = '';
}
</script>
{% endblock %}
